<html>

<head>
    <title>Word Helper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <div class="container m-2">
        <nav class="navbar navbar-light bg-light">
            <a class="navbar-brand">Word Helper</a>
            <div class="form-check form-switch form-control-lg">
                <input class="form-check-input" type="checkbox" role="switch" id="acentos">
                <label class="form-check-label" for="acentos">Usar acentos</label>
            </div>
            <form class="form-inline form-control-lg">
                <label class="form-control-label" for="wlen">Longitud Palabra</label>
                <select class="form-select" aria-label="Default select example" id="wlen">
                    <option value="2">2 letras</option>
                    <option value="3">3 letras</option>
                    <option value="4">4 letras</option>
                    <option selected value="5">5 letras</option>
                    <option value="6">6 letras</option>
                    <option value="7">7 letras</option>
                    <option value="8">8 letras</option>
                    <option value="9">9 letras</option>
                    <option value="10">10 letras</option>
                    <option value="11">11 letras</option>
                    <option value="12">12 letras</option>
                    <option value="13">13 letras</option>
                    <option value="14">14 letras</option>
                    <option value="15">15 letras</option>
                    <option value="16">16 letras</option>
                </select>
            </form>
        </nav>
    </div>
    <div class="container m-2" id="cmensaje">
        <span class="m-2" id="mensaje"></span>
    </div>
    <div class="container text-center m-2">
        <div class="row" id="letras_cont">
        </div>
    </div>
    <div class="container m-2" id="cresultado">
        <span class="m-2" id="resultado">Resultado</span>
        <select class="form-select m-2" multiple id="resultados">
        </select>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="rae.js"></script>

    <script>
        const $word_len = document.getElementById("wlen")
        const $letras_cont = document.getElementById("letras_cont")
        const $acentos = document.getElementById("acentos")
        const $resultados = document.getElementById("resultados")
        var wlen = parseInt($word_len.value)
        var acentos = $acentos.checked
        var palabra = ""
        var palabra_vacia = ""
        var previousIsAccent = false

        create_letras($letras_cont, wlen)

        function create_letras(c, l) {
            //Update mensaje
            document.getElementById("mensaje").innerText = "El diccionario de la RAE contiene " +
                rae_words[wlen - 1].length + " palabras de " + wlen + " letras"
            //remove all elements
            while (c.firstChild) {
                c.removeChild(c.lastChild)
            }
            //Añade un elemento por cada letra
            palabra_vacia = ""
            for (let i = 0; i < l; i++) {
                but = document.createElement("button")
                but.setAttribute("type", "button")
                but.setAttribute("id", "letra_" + i)
                but.setAttribute("onkeydown", "tecla(event, " + i + ")")
                but.classList.add("btn")
                but.classList.add("btn-outline-dark")
                but.classList.add("align-middle")
                but.classList.add("letras")
                but.appendChild(document.createTextNode(" "))
                div = document.createElement("div")
                div.classList.add("col")
                div.appendChild(but)
                c.appendChild(div)
                palabra_vacia = palabra_vacia + "."
            }
            palabra = palabra_vacia
        }

        function tecla(e, t) {

            palabra_temp = palabra

            //Gestiona la tecla pulsada y cambia las letras en pantalla
            if (e.which == 8) { // Pressed Delete
                previousIsAccent = false
                document.getElementById("letra_" + t).innerText = ""
                palabra_temp = palabra_temp.replaceAt(t, ".")
            } if (e.which == 222) { //Presionado el acento agudo
                previousIsAccent = true
            } else {
                pulsada = String.fromCharCode(e.which).toLowerCase()
                if (isVocal(pulsada) && previousIsAccent)
                    pulsada = acentua(pulsada)
                previousIsAccent = false

                if (!acentos) { //No se permiten acentos
                    if (pulsada >= 'a' && pulsada <= 'z') {
                        document.getElementById("letra_" + t).innerText = pulsada
                        palabra_temp = palabra_temp.replaceAt(t, pulsada)
                    }
                } else { //Acentos permitidos
                    if (pulsada >= 'a' && pulsada <= 'z' || isAcentuada(pulsada)) {
                        console.log("con acento " +pulsada)
                        document.getElementById("letra_" + t).innerText = pulsada
                        palabra_temp = palabra_temp.replaceAt(t, pulsada)
                    }
                }
            }

            // Si la palabra ha cambiado y no es vacía
            // Construye la expresión de busqueda y busca en el diccionario
            res = []
            exp = ""
            if (palabra_temp != palabra && palabra_temp != palabra_vacia) {
                if (!acentos) { // No se permiten acentos
                    for (let i = 0; i < palabra_temp.length; i++) {
                        switch (palabra_temp[i]) {
                            case 'a':
                                exp = exp + '[a,á]'
                                break
                            case 'e':
                                exp = exp + '[e,é]'
                                break
                            case 'i':
                                exp = exp + '[i,í]'
                                break
                            case 'o':
                                exp = exp + '[o,ó]'
                                break
                            case 'u':
                                exp = exp + '[u,ú]'
                                break
                            default:
                                exp = exp + palabra_temp[i]
                        }
                    }
                } else { //Acentos permitidos
                    exp = palabra_temp
                }
                rexp = new RegExp(exp)
                res = rae_words[wlen - 1].filter((x) => { return rexp.exec(x) })
            }

            palabra = palabra_temp

            document.getElementById("resultado").innerText = "Encontradas " + res.length +
                " palabras con este patrón"

            while ($resultados.firstChild)
                $resultados.removeChild($resultados.lastChild)

            res.forEach(element => {
                opt = document.createElement("option")
                opt.setAttribute("value", element)
                opt.innerText = element
                $resultados.appendChild(opt)
            });
        }

        $word_len.addEventListener('change', function () {
            palabra = ""
            wlen = parseInt($word_len.value)
            create_letras(letras_cont, wlen)
        })

        $acentos.addEventListener('change', function(){
            acentos = $acentos.checked
            create_letras($letras_cont, wlen)
        })

        String.prototype.replaceAt = function (index, replacement) {
            return this.substring(0, index) + replacement + this.substring(index + replacement.length);
        }

        function isVocal(letra) {
            if (letra === 'a' ||
                letra === 'e' ||
                letra === 'i' ||
                letra === 'o' ||
                letra === 'u')
                return true
            else
                return false
        }
        
        function acentua (vocal){
            switch (vocal){
                case 'a':
                    return 'á'
                case 'e':
                    return 'é'
                case 'i':
                    return 'í'
                case 'o':
                    return 'ó'
                case 'u':
                    return 'ú'
                default:
                    return vocal
            }
        }
        function isAcentuada(letra) {
            if (letra === 'á' ||
                letra === 'é' ||
                letra === 'í' ||
                letra === 'ó' ||
                letra === 'ú')
                return true
            else
                return false
        }

    </script>
</body>

</html>