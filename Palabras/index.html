<html>

<head>
    <title>Word Helper</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <nav class="navbar navbar-light bg-light">
            <a class="navbar-brand">Word Helper</a>
            <div class="form-check form-switch form-control-lg">
                <input class="form-check-input" type="checkbox" role="switch" id="acentos">
                <label class="form-check-label" for="acentos">Usar acentos</label>
            </div>
            <form class="form-inline form-control-lg">
                <label class="form-control-label" for="wlen">Longitud Palabra</label>
                <select class="form-select" aria-label="Default select example" id="wlen">
                    <option value="2">2 letras</option>
                    <option value="3">3 letras</option>
                    <option value="4">4 letras</option>
                    <option selected value="5">5 letras</option>
                    <option value="6">6 letras</option>
                    <option value="7">7 letras</option>
                    <option value="8">8 letras</option>
                    <option value="9">9 letras</option>
                    <option value="10">10 letras</option>
                    <option value="11">11 letras</option>
                    <option value="12">12 letras</option>
                    <option value="13">13 letras</option>
                    <option value="14">14 letras</option>
                    <option value="15">15 letras</option>
                    <option value="16">16 letras</option>
                </select>
            </form>
        </nav>
    </div>
    <div class="container m-2 mensajes" id="cmensaje">
        <span class="m-2" id="mensaje"></span>
    </div>
    <div class="container m-2">
    </div>
    <div class="container m-2 mensajes">
        <span class="m-2">Letras Sugeridas</span>
    </div>
    <div class="container text-center m-2">
        <div class="row justify-content-md-center">
            <div class="col col-lg-2"></div>
            <div class="col-md-auto">
                <div class="row" id="letras_cont"></div>
            </div>
            <div class="col col-lg-2"></div>
        </div>
    </div>
    <div class="container m-2 mensajes">
        <span class="m-2">Letras Prohibidas</span>
    </div>
    <div class="container text-center m-2">
        <div class="row">
            <div class="col">
                <input type="text" id="letrasP" class="form-control" maxlength="12" oninput="teclaProhibidas(event)">
            </div>
            <div class="col"></div>
            <div class="col"></div>
        </div>
    </div>
    <div class="container m-2" id="cresultado">
        <span class="m-2" id="resultado">Palabras que se ajustan al patron</span>
        <select class="form-select m-2" multiple id="resultados">
        </select>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="rae.js"></script>

    <script>
        const $word_len = document.getElementById("wlen")
        const $letras_cont = document.getElementById("letras_cont")
        const $acentos = document.getElementById("acentos")
        const $resultados = document.getElementById("resultados")
        var wlen = parseInt($word_len.value)
        var acentos = $acentos.checked
        var palabra = ""
        var palabra_vacia = ""
        var previousIsAccent = false
        var letrasProhibidas = []

        createPatron($letras_cont, wlen)

        function createPatron(c, l) {
            //Update mensaje
            document.getElementById("mensaje").innerText = "El diccionario de la RAE contiene " +
                rae_words[wlen - 1].length + " palabras de " + wlen + " letras"
            //remove all elements from $letras_cont
            while (c.firstChild) {
                c.removeChild(c.lastChild)
            }
            //Añade un elemento por cada letra
            palabra_vacia = ""
            for (let i = 0; i < l; i++) {
                letraBox = document.createElement("input")
                letraBox.setAttribute("type", "text")
                letraBox.setAttribute("maxlength", "1")
                letraBox.setAttribute("oninput", "teclaPatron(event, " + i + ")")
                letraBox.setAttribute("id", "letra_" + i)
                letraBox.classList.add("form-control")
                letraBox.classList.add("letras")
                col = document.createElement("div")
                col.classList.add("col")
                col.appendChild(letraBox)
                c.appendChild(col)
                palabra_vacia = palabra_vacia + "."
            }
            palabra = palabra_vacia

            //Vacia la tabla de resultados
            while ($resultados.firstChild)
                $resultados.removeChild($resultados.lastChild)
        }

        function teclaPatron(e, t) {
            palabra_temp = palabra

            if (e.inputType === "deleteContentBackward") { // Pressed Delete
                document.getElementById("letra_" + t).value = ""
                palabra_temp = palabra_temp.replaceAt(t, ".")
            } else if (e.inputType ==="insertText") {
                char = e.data.toLowerCase()
                if (isLetraValida(char)) {
                    document.getElementById("letra_" + t).value = char
                    palabra_temp = palabra_temp.replaceAt(t, char)
                } else {
                    document.getElementById("letra_" + t).value = ""
                }
            }

            // Si la palabra ha cambiado
            // Realiza el filtro
            if (palabra_temp == palabra_vacia){ //Vacia resultados
                while ($resultados.firstChild)
                $resultados.removeChild($resultados.lastChild)
                document.getElementById("resultado").innerText = "Palabras que se ajustan al patron"
            } else if (palabra_temp != palabra) {
                res = filtrar(palabra_temp, letrasProhibidas)
                updateResultados(res)
            }

            palabra = palabra_temp
        }

        function teclaProhibidas(e) {
            ol = letrasProhibidas.length
            if (e.inputType === "deleteContentBackward") { // Pressed Delete
                letrasProhibidas.pop()
            } else if (e.inputType === "insertText") {
                char = e.data.toLowerCase()

                s = array2String(letrasProhibidas)
                if (isLetraValida(char)) {
                    s = s + char
                    letrasProhibidas = string2Array(s)
                }
                document.getElementById("letrasP").value = s
            }

            if (palabra != palabra_vacia && letrasProhibidas.length != ol) {
                res = filtrar(palabra, letrasProhibidas)
                updateResultados(res)
            }
        }

        $word_len.addEventListener('change', function () {
            palabra = ""
            wlen = parseInt($word_len.value)
            createPatron(letras_cont, wlen)
        })

        $acentos.addEventListener('change', function () {
            acentos = $acentos.checked
            createPatron($letras_cont, wlen)
        })

        String.prototype.replaceAt = function (index, replacement) {
            return this.substring(0, index) + replacement + this.substring(index + replacement.length);
        }

        function updateResultados(res) {
            document.getElementById("resultado").innerText = "Encontradas " + res.length +
                " palabras con este patrón"

            while ($resultados.firstChild)
                $resultados.removeChild($resultados.lastChild)

            res.forEach(element => {
                opt = document.createElement("option")
                opt.setAttribute("value", element)
                opt.innerText = element
                $resultados.appendChild(opt)
            });
        }

        function filtrar(palabra, letrasProhibidas) {
            res = rae_words[wlen - 1].filter((x) => { return generateRegexp(palabra).exec(x) })
            ret = []
            for (let i = 0; i < res.length; i++) {
                test = true
                for (let j = 0; j < letrasProhibidas.length; j++) {
                    if (res[i].indexOf(letrasProhibidas[j]) > -1) { //Contiene letra prohibida
                        test = false;
                    }
                }
                if (test)
                    ret.push(res[i])
            }
            return ret
        }

        function generateRegexp(palabra) {
            exp = ""
            if (!acentos) { //No hay acentos
                for (let i = 0; i < palabra.length; i++) {
                    switch (palabra[i]) {
                        case 'a':
                            exp = exp + '[a,á]'
                            break
                        case 'e':
                            exp = exp + '[e,é]'
                            break
                        case 'i':
                            exp = exp + '[i,í]'
                            break
                        case 'o':
                            exp = exp + '[o,ó]'
                            break
                        case 'u':
                            exp = exp + '[u,ú]'
                            break
                        default:
                            exp = exp + palabra[i]
                    }
                }
            } else {
                exp = palabra
            }
            return new RegExp(exp)
        }

        function isLetraValida(letra) {
            if (!acentos) // No se permiten acentos
                return (letra >= 'a' && letra <= 'z')
            else // acentos permitidos
                return ((letra >= 'a' && letra <= 'z') || isAcentuada(letra))
        }

        function isVocal(letra) {
            if (letra === 'a' ||
                letra === 'e' ||
                letra === 'i' ||
                letra === 'o' ||
                letra === 'u')
                return true
            else
                return false
        }

        function acentua(vocal) {
            switch (vocal) {
                case 'a':
                    return 'á'
                case 'e':
                    return 'é'
                case 'i':
                    return 'í'
                case 'o':
                    return 'ó'
                case 'u':
                    return 'ú'
                default:
                    return vocal
            }
        }

        function isAcentuada(letra) {
            if (letra === 'á' ||
                letra === 'é' ||
                letra === 'í' ||
                letra === 'ó' ||
                letra === 'ú')
                return true
            else
                return false
        }

        function array2String(arr) {
            ret = ""
            arr.forEach((x) => { ret = ret + x })
            return ret
        }

        function string2Array(s) {
            ret = []
            for (let i = 0; i < s.length; i++)
                ret[i] = s[i]
            return ret
        }

    </script>
</body>

</html>